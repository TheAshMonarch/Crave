<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token() }}" />
    <title>
      {% block title %}
        Crave - My Recipes
      {% endblock %}
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
    <script src="{{ url_for('static', filename='js/comments.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        overflow-x: hidden;
      }
      .cloud {
        position: absolute;
        background-color: #5b6777;
        border-radius: 50%;
        opacity: 0.8;
        filter: blur(20px);
        animation: float 12s ease-in-out infinite;
        z-index: -1;
        will-change: transform;
      }
      .cloud:nth-child(1) {
        width: 200px;
        height: 80px;
        top: 20%;
        left: 10%;
        animation-delay: 0s;
      }
      .cloud:nth-child(2) {
        width: 300px;
        height: 100px;
        top: 40%;
        left: 60%;
        animation-delay: 3s;
      }
      .cloud:nth-child(3) {
        width: 250px;
        height: 90px;
        top: 70%;
        left: 30%;
        animation-delay: 6s;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      .nav-link {
        position: relative;
      }
      .nav-link::after {
        content: '';
        position: absolute;
        width: 0;
        height: 2px;
        bottom: -2px;
        left: 0;
        background-color: #f97316;
        transition: width 0.3s ease;
      }
      .nav-link:hover::after {
        width: 100%;
      }
      .desktop-menu {
        display: flex;
      }
      .mobile-menu {
        display: none;
      }
      #mobile-nav {
        display: none;
        transform: scaleY(0);
        transform-origin: top;
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
      }
      #mobile-nav:not(.hidden) {
        display: flex;
        transform: scaleY(1);
        opacity: 1;
      }
      @media (max-width: 768px) {
        .desktop-menu {
          display: none !important;
        }
        .mobile-menu {
          display: block !important;
        }
        #mobile-nav:not(.hidden) {
          display: flex;
          transform: scaleY(1);
          height: auto;
        }
        #menu-btn {
          background: none;
          border: none;
          cursor: pointer;
          padding: 0.5rem;
        }
      }
    </style>
  </head>

  <body class="bg-white text-gray-800 min-h-screen">
    <div class="cloud" aria-hidden="true"></div>
    <div class="cloud" aria-hidden="true"></div>
    <div class="cloud" aria-hidden="true"></div>

    <nav class="bg-white shadow-md sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-2">
          <div class="h-10 w-10">
            <img src="{{ url_for('static', filename='images/mascot.png') }}" alt="Crave Logo" class="h-full w-full object-contain" />
          </div>
          <span class="text-xl font-bold">Crave</span>
        </div>
        <ul class="desktop-menu flex items-center gap-6 text-sm font-medium">
          <li>
            <a href="{{ url_for('home') }}" class="nav-link hover:text-orange-500">Home</a>
          </li>
          <li>
            <a href="{{ url_for('view_recipes') }}" class="nav-link hover:text-orange-500">Recipes</a>
          </li>
          <li>
            <a href="{{ url_for('view_favorites') }}" class="nav-link hover:text-orange-500">Favorites</a>
          </li>
          <li>
            <a href="{{ url_for('profile') }}" class="nav-link hover:text-orange-500">Profile</a>
          </li>
          <li>
            <a href="{{ url_for('add_recipe') }}" class="nav-link hover:text-orange-500">Add Recipe</a>
          </li>
          {% if session.user_id %}
            <li>
              <a href="{{ url_for('logout') }}" class="nav-link hover:text-orange-500">Logout</a>
            </li>
          {% else %}
            <li>
              <a href="{{ url_for('login') }}" class="nav-link hover:text-orange-500">Login</a>
            </li>
            <li>
              <a href="{{ url_for('register') }}" class="nav-link hover:text-orange-500">Register</a>
            </li>
          {% endif %}
        </ul>
        <div class="mobile-menu">
          <button id="menu-btn" class="focus:outline-none" aria-label="Toggle navigation menu">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>
      <div id="mobile-nav" class="hidden flex-col px-6 pb-4 space-y-2 bg-white shadow-md">
        <a href="{{ url_for('home') }}" class="nav-link hover:text-orange-500">Home</a>
        <a href="{{ url_for('view_recipes') }}" class="nav-link hover:text-orange-500">Recipes</a>
        <a href="{{ url_for('view_favorites') }}" class="nav-link hover:text-orange-500">Favorites</a>
        <a href="{{ url_for('profile') }}" class="nav-link hover:text-orange-500">Profile</a>
        <a href="{{ url_for('add_recipe') }}" class="nav-link hover:text-orange-500">Add Recipe</a>
        {% if session.user_id %}
          <a href="{{ url_for('logout') }}" class="nav-link hover:text-orange-500">Logout</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="nav-link hover:text-orange-500">Login</a>
          <a href="{{ url_for('register') }}" class="nav-link hover:text-orange-500">Register</a>
        {% endif %}
      </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-12">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          <div class="toast-container">
              {% for category, message in messages %}
                  <div class="toast {{ category }}">{{ message }}</div>
              {% endfor %}
          </div>
      {% endif %}
      {% endwith %}
      {% block content %}
      {% endblock %}
    </main>

    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
<script>
  // Flag to track if we've already initialized
  let favoritesInitialized = false;

  document.addEventListener('DOMContentLoaded', function () {
    const menuBtn = document.getElementById('menu-btn');
    const mobileNav = document.getElementById('mobile-nav');
    if (menuBtn && mobileNav) {
      menuBtn.addEventListener('click', () => {
        mobileNav.classList.toggle('hidden');
      });
    }

    // Only initialize favorites once
    if (!favoritesInitialized) {
      initializeFavorites();
      favoritesInitialized = true;
    }

    // Toast Function
    function showToast(message, isError = false) {
      // Clear any existing toasts first
      const existingToasts = document.querySelectorAll('#toast-container > div');
      existingToasts.forEach(toast => toast.remove());

      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 p-4 rounded-md shadow-md text-white z-50 transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
      toast.textContent = message;
      document.getElementById('toast-container').appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);

      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Trigger toast from flash messages
    {% set flashed_messages = get_flashed_messages() %}
    const toastMessage = "{% if flashed_messages %}{{ flashed_messages[0] }}{% endif %}";
    if (toastMessage) {
      showToast(toastMessage);
      history.replaceState({}, document.title, window.location.pathname);
    }

    // Initialize favorites function
    function initializeFavorites() {
      // Remove any existing event listeners first by cloning the forms
      document.querySelectorAll('form.favorite-form').forEach(form => {
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
      });

      // Initialize favorite buttons based on their current state
      document.querySelectorAll('form.favorite-form').forEach((form) => {
        const button = form.querySelector('button');
        // Set initial classes based on current text
        if (button.textContent.includes('Remove')) {
          button.classList.remove('text-orange-500');
          button.classList.add('text-red-500');
        } else {
          button.classList.remove('text-red-500');
          button.classList.add('text-orange-500');
        }
      });

      // Add NEW event listeners
      document.querySelectorAll('form.favorite-form').forEach((form) => {
        form.addEventListener('submit', async function favoriteHandler(e) {
          e.preventDefault();
          const button = form.querySelector('button');

          // Disable button during request to prevent double clicks
          button.disabled = true;
          const originalText = button.textContent;
          button.textContent = '...';

          try {
            const formData = new FormData(form);
            const response = await fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                'X-Requested-With': 'XMLHttpRequest'
              }
            });

            if (!response.ok) throw new Error('Network error');
            const data = await response.json();

            if (data.success) {
              if (data.action === 'added') {
                button.textContent = 'Remove Favorite';
                button.classList.remove('text-orange-500');
                button.classList.add('text-red-500');
                // Confetti effect
                if (typeof confetti === 'function') {
                  confetti({particleCount: 100, spread: 70, origin: {y: 0.6}});
                }
                showToast(data.message || 'Added to favorites!');
              } else if (data.action === 'removed') {
                button.textContent = 'Save to Favorites';
                button.classList.remove('text-red-500');
                button.classList.add('text-orange-500');
                showToast(data.message || 'Removed from favorites!');
              }
            } else {
              showToast(data.error || 'An error occurred', true);
              // Revert button text on error
              button.textContent = originalText;
            }
          } catch (error) {
            console.error('Error:', error);
            showToast('An error occurred', true);
            // Revert button text on error
            button.textContent = originalText;
          } finally {
            // Re-enable button
            button.disabled = false;
          }
        });
      });
    }
  });
</script>
</html>